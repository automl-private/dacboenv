"""Utils for warmstarting optimization runs."""

from __future__ import annotations

import ast
from dataclasses import fields
from pathlib import Path
from typing import TYPE_CHECKING

import pandas as pd
from ConfigSpace import Configuration, ConfigurationSpace
from hydra.utils import instantiate
from omegaconf import OmegaConf
from rich.progress import track
from smac.callback.callback import Callback
from smac.runhistory.dataclasses import TrialInfo, TrialValue

from dacboenv.utils.loggingutils import get_logger

if TYPE_CHECKING:
    from carps.utils.task import InputSpace
    from smac.main.smbo import SMBO

logger = get_logger("TVGen")


def build_configspace(cfg_str: str) -> ConfigurationSpace:
    """Build configuration space from saved config.

    Parameters
    ----------
    cfg_str : str
        The saved config as a string.

    Returns
    -------
    ConfigurationSpace
        The configuration space.
    """
    cfg_dict = ast.literal_eval(cfg_str)
    cfg = OmegaConf.create(cfg_dict)
    input_space: InputSpace = instantiate(cfg.task.input_space)
    return input_space.configuration_space


class TrialValueGenerator:
    """Trial Value Generator.

    Generate trials to tell from previous runs.

    Usage:
    ```python
    task_id="some_task"
    tv_gen = TrialValueGenerator(task_id=task_id)
    trial_info, trial_value = next(tv_gen)
    ```
    """

    def __init__(
        self,
        task_id: str,
        trajectory_csv_fn: str | Path = "runs/trajectory.csv",
    ) -> None:
        """Init.

        Parameters
        ----------
        task_id : str
            The task id.
        trajectory_csv_fn : str | Path, optional
            The filename of the trajectory csv (generated by `collect_incumbents.py`), by default "runs/trajectory.csv"
        """
        self._task_id = task_id
        self._trajectory_df = pd.read_csv(trajectory_csv_fn)
        self._trajectory_df = self._trajectory_df[self._trajectory_df["task_id"] == self._task_id]
        missing_infos = self._trajectory_df["trial_info"].isna()
        if any(missing_infos):
            logger.info(f"Dropping {sum(missing_infos)} trials due to missing `trial_info` field.")
            self._trajectory_df = self._trajectory_df[~missing_infos]
        logger.info(f"ðŸŽ Found {len(self._trajectory_df)} previous runs.")
        self._configspace = build_configspace(self._trajectory_df.iloc[0]["config"])
        self._row_iter = self._trajectory_df.iterrows()

    def __len__(self) -> int:
        return len(self._trajectory_df)

    def __iter__(self) -> TrialValueGenerator:
        return self

    def __next__(self) -> tuple[TrialInfo, TrialValue]:
        _, row = next(self._row_iter)  # raises StopIteration automatically
        trial_info_dict = ast.literal_eval(row["trial_info"])
        trial_value_dict = ast.literal_eval(row["trial_value"])

        trial_info_dict["config"] = Configuration(
            configuration_space=self._configspace,
            vector=trial_info_dict["config"],
        )

        field_names_ti = [f.name for f in fields(TrialInfo)]
        trial_info = TrialInfo(**{f: trial_info_dict[f] for f in field_names_ti})

        field_names_tv = [f.name for f in fields(TrialValue)]
        trial_value = TrialValue(**{f: trial_value_dict[f] for f in field_names_tv if f in trial_value_dict})

        return trial_info, trial_value


class WarmstartCallback(Callback):
    """Warmstart callback to tell trials."""

    def __init__(
        self,
        task_id: str,
        trajectory_csv_fn: str | Path = "runs/trajectory.csv",
    ) -> None:
        """Init.

        Parameters
        ----------
        task_id : str
            The task id.
        trajectory_csv_fn : str | Path, optional
            The filename of the trajectory csv (generated by `collect_incumbents.py`), by default "runs/trajectory.csv"
        """
        self._tv_gen = TrialValueGenerator(task_id=task_id, trajectory_csv_fn=trajectory_csv_fn)

    def on_start(self, smbo: SMBO) -> None:
        """On start tell all available trials.

        Parameters
        ----------
        smbo : SMBO
            SMAC optimizer.
        """
        n_trials = len(self._tv_gen)
        for trial_info, trial_value in track(self._tv_gen, description="Telling trials...", total=n_trials):
            smbo.tell(info=trial_info, value=trial_value, save=False)
        del self._tv_gen
        return super().on_start(smbo)
